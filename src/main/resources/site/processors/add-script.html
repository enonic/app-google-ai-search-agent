<link rel="stylesheet" data-th-href="${styleSrc}" type="text/css" media="all"/>

<!-- Widget JavaScript bundle -->
<script src="https://cloud.google.com/ai/gen-app-builder/client?hl=en_US"></script>

<!-- Search widget element is not visible by default -->
<gen-search-widget data-th-configId="${configID}"
                   data-th-triggerId="${triggerID}"
                   data-th-placeholder="${inputPlaceholder}">
</gen-search-widget>


<script th:inline="javascript">
    /*<![CDATA[*/
    const tokenServiceUrl = /*[[${tokenServiceUrl}]]*/ undefined;
    const triggerId = /*[[${triggerID}]]*/ undefined;
    /*]]>*/

    document.addEventListener('DOMContentLoaded', function() {
        const triggerEl = document.querySelector(`#${triggerId}`);
        const widget = document.querySelector('gen-search-widget');
        const htmlEl = document.documentElement;
        let intervalId = null;

        function checkContentInShadow() {
            const shadowRoot = widget && widget.shadowRoot;
            const target = shadowRoot ? shadowRoot.querySelector('.content') : null;
            if (!target) {
                htmlEl.style.fontSize = '';
                clearInterval(intervalId);
                intervalId = null;
                triggerEl.addEventListener('click', onTriggerClick, {once: true});
            }
        }

        function onTriggerClick(e) {
            triggerEl.removeEventListener('click', onTriggerClick);
            htmlEl.style.fontSize = '100%';
            setTimeout(() => {
                intervalId = setInterval(checkContentInShadow, 100);
            }, 500);
        }

        function renewToken() {
            fetch(tokenServiceUrl)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        console.error('Failed to get google token, make sure you have correct application configuration.');
                    }
                })
                .then(data => {
                    if (!data) {
                        return;
                    }
                    if (data.token) {
                        widget.authToken = data.token;
                        triggerEl.classList.add('active');
                    } else {
                        widget.authToken = null;
                        triggerEl.classList.remove('active');
                    }
                    if (data.expires) {
                        setTimeout(renewToken, data.expires - Date.now());
                    }
                });
        }

        if (tokenServiceUrl) {
            renewToken();
        }

        triggerEl.addEventListener('click', onTriggerClick, {once: true});
    });
</script>
